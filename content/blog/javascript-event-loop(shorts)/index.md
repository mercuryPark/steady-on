---
title: 이벤트 루프 이해하기
subtitle: 자바스크립트의 이벤트 루프
date: "2025-01-08T23:46:37.121Z"
signboard: true
shorts: false
tags:
  - JavaScript
  - Theory
  - Shorts
thumbnail_image: "./eventloop_thumbnail.jpeg"
---

## 비동기처리는 어려워

JS를 공부할 때 가장 처음에 마주하는 동기/비동기에 대해 들어보셨나요?<br/>

자바스크립트는 싱글스 레드 언어라고 하는데, 도대체 한 번에 하나씩 일할 수 있는
우리의 자바스크립트 엔진은 어떻게 동기/비동기 처리를 아름답게 해낼까요?<br/>

바로 든든한 브라우저라는 친구가 비동기 처리를 대신해주기 때문입니다.

## 이벤트루프 이해하기

비동기, 이벤트 루프, 콜 스택, 콜백 큐, 웹 APIs...

설명하는 글이 수도 없이 많지만, 이해하기 전까지는 볼 때마다 새로운 단어입니다.
그래서 gpt와 놀던 중 상황극을 한번 부여해 봤습니다.

### 소개

`1. Call Stack - 요리사`<br/>
`2. Web APIs (브라우저) - 주방의 외주업체`<br/>
`3. Callback Queue - 대기 중인 음식`<br/>
`4. Event Loop - 가게 매니저`<br/>
`5. Job (해야할 작업, 요청) - 손님의 주문`<br/>
`6. Async Job(비동기 작업, 요청) - 손님의 특별한 주문`<br/>
`7. Call Stack 오버플로우 - 많은 일, 혼잡함`<br/>
`8. Microtask Queue - 급한 주문`<br/>
`9. Tick - 손님이 요청한 일이 더 남았는지 확인`<br/>

### 레스토랑의 하루

`손님의 주문`이 들어오고 메뉴를 주문합니다.
`요리사`는 주문한 메뉴를 준비합니다.

```javascript
console.log("여기 음식 나왔습니다 :)") // Call Stack에서 즉시 실행
```

`손님의 특별한 디저트 주문`이 들어왔습니다.<br/>
이 주문은 시간이 오래걸리고 효율적이지 못합니다.<br/>
`요리사`는 디저트 전문 `외주업체`에게 맡깁니다.

```javascript
setTimeout(() => {
  console.log("디저트 제작이 완료되었습니다.") // Callback Queue에 들어감
}, 3000)
```

디저트를 맡긴 뒤 `요리사`는 또다른 `손님의 주문`을 준비합니다.

```javascript
console.log("지금 음식을 준비중입니다.") // Call Stack에서 즉시 실행
```

```javascript
console.log("여기 다음 음식 나왔습니다!") // Call Stack에서 즉시 실행
```

`가게 매니저`가 디저트가 완료되었다는 소식을 듣습니다.<br/>
`요리사`가 빈손이 되고 준비된 디저트가 제공됩니다.

순서가 어떻게될까요?

`1`. 첫번째 음식전달<br/> `2`. 두번째 음식 준비 중... <br/>`3`. 두번째 음식 전달<br/> `4`. 디저트 완성 후 전달

### 번외 (특별한 상황)

주문이 너무 많고 `혼잡한 일`이 생겨버렸습니다.

```javascript
function cook() {
  // 재귀 함수 (loop)
  cook()
}
cook()
```

`가게 매니저`는 `급한(작은)주문`부터 우선적으로 처리합니다.

```javascript
Promise.resolve().then(() => console.log("여기 물 좀 주세요!")) // Microtask Queue에 들어감
```

`가게 매니저`가 `주문이 더 있는지` 확인합니다.

먼저 `급한 일`부터 확인합니다. `급한 일`이 다끝났거나 이제 없으면
`대기 중인 음식`이 있는지 확인합니다.

`가게 매니저`는 `주문이 더 있는지` 두 번 확인했네요.

```javascript
console.log("떡볶이 나왔습니다.") // Call Stack에서 즉시 실행

setTimeout(() => {
  console.log("디저트 나왔습니다.") // Callback Queue에 들어감
}, 0)

Promise.resolve().then(() => {
  console.log("흘리셨나요? 여기 티슈있습니다.") // Microtask Queue에 들어감
})

console.log("순대 나왔습니다..") // Call Stack에서 즉시 실행
```

## 마무리

![image](./event-loop.png)
<span class="img-description">_(이벤트 루프)_</span>

상황극 잘 보셨나요? 이 등장인물들과 배경요소를 실제 JS 작동 순서, 원리에
다시 대입해 보세요.<br/>

저는 개인적으로 생소하고 어려운 개념 공부일수록 쉽고 간단하게 다가가려 합니다.<br/>
결국엔 맞닥뜨려야 하는 실제 상황에서는 갈고닦아왔던 생각과 지식들을 펼쳐놓아야겠지만,<br/> 이 과정이 지루하고 답답하고 힘들다면 남는 것도 적다고 생각하는 편입니다.

결론은 이 레스토랑은 요리사가 요리하는 만큼 외주업체도 많이 사용한다는 뜻입니다.<br/>
비동기처리라고하면 보통 setTimeout으로만 예시를 많이 들곤하는데,
파일업로드, 실시간 데이터 업데이트(웹소켓), API요청 또한 비동기 처리로 많이 진행됩니다.<br/>

실제로는 외주업체를 많이많이 사용하고 있다는 뜻이지요.<br/>

매니저는 항상 이 일들을 고르게 분배해주고 조율을 잘하는 조율자이며,<br/>
우리는 손님의 입장이기때문에 이해되지 않는 동작순서를 마주하게된다면<br/>

급한주문(Microtask Queue)이 우선이라는 점을 한번 떠올려보고,<br/>
이전 작업이 마무리되고 다음 이벤트 루프 사이클로 넘어가는 시점(Tick)으로 <br/>넘어가지 않았는지 확인해보는 것도 좋은 방법이라고 생각합니다.<br/>

이해가 잘 안되는 부분이 생길 때 이렇게 일상생활에 상황극을 빗대어보면<br/>
가끔 마주하는 이론과 친해지지 않을까요?

## 마무리2

**1. 자바스크립트는 싱글스레드 언어입니다. 한번에 한가지 일만 할 수 있습니다.**

**2. 비동기 함수는 Web API를 통해 브라우저에서 갖고있습니다. 이때는 아직 실행되기 전을 의미합니다.**

**2-1. setTimeout 같은 경우에는 코드자체가 실행되고 2초뒤에 내용물이 실행되는 원리입니다. 콜스택에서 실행되고 지운뒤 타이머를 브라우저에서 2초동안 실행한 뒤 콜백큐에 전달 후 콜스택에서 실행됩니다.**

**2-2. api 요청은 브라우저 백그라운드 (브라우저의 다른 스레드)에서 실행됩니다.
이때 응답이 완료되면, Web API는 해당 요청에 대한 콜백 함수를 콜백 큐(정확히는 태스크 큐)로 이동시킵니다. 이렇게 데이터를 전달받을 수 있습니다.**

**3. 비동기 처리중에서도 마이크로태스크큐에 들어가는 함수(Promise)는 일반 비동기함수보다 우선순위가 높습니다.**

**4. 동기 함수가 콜스택 큐에서 실행되고 이벤트 루프에서 콜스택 큐가 비어있을 때를
캐치해 콜백큐에서 기다리고있는 비동기 함수를 실행합니다.**

**5. 동기함수와 비동기함수는 모두 싱글스레드에서 순서대로 실행됩니다.
그러나 시작은 순서를 지키며 시작하지만, 그 전 함수의 완료를 기다리는 동기함수와 다르게 비동기함수는 다른 비동기함수의 완료를 기다리지 않고 실행되기에 동시에 실행되는 것 같은 느낌을 받습니다.**

**추가:비동기 함수도 처음에는 콜스택으로 이동합니다. 이동 후 비동기 함수로 판단되면 콜스택에서 삭제한 뒤 타이머나 HTTP요청을 브라우저에서 실행하고 다시 콜백큐 -> 콜스택으로 돌아옵니다.**
